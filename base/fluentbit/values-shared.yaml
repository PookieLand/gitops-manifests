fluent-bit:
  backend:
    type: opensearch

  flush: 1
  logLevel: info

  serviceAccount:
    create: true

  rbac:
    create: true

  # Container volume mounts for accessing host logs
  volumeMounts:
    - name: varlog
      mountPath: /var/log
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: etcmachineid
      mountPath: /etc/machine-id
      readOnly: true

  # DaemonSet volumes backing the container mounts
  daemonSetVolumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: etcmachineid
      hostPath:
        path: /etc/machine-id
        type: FileOrCreate

  config:
    inputs: |
      [INPUT]
          Name              tail
          Path              /var/log/containers/*.log
          Parser            docker
          Tag               kube.*
          DB                /var/log/flb_kube.db
          Mem_Buf_Limit     50MB
          Refresh_Interval  5
          Skip_Long_Lines   On

    filters: |
      [FILTER]
          Name                kubernetes
          Match               kube.*
          Kube_URL            https://kubernetes.default.svc:443
          Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix     kube.var.log.containers.
          Merge_Log           On
          Keep_Log            Off
          K8S-Logging.Parser  On
          K8S-Logging.Exclude On
          Labels              On
          Annotations         Off

      [FILTER]
          Name                nest
          Match               kube.*
          Operation           lift
          Nested_under        kubernetes
          Add_prefix          k8s_

      [FILTER]
          Name                modify
          Match               kube.*
          Add                 environment ${ENVIRONMENT}
          Add                 cluster ${CLUSTER_NAME}
          Copy                k8s_pod_name pod_name
          Copy                k8s_namespace_name namespace
          Copy                k8s_container_name container_name

      # Extract service name from pod_name using regex
      # Pod naming: <service>-<replica_set>-<pod_hash>
      # Extracts the service name prefix before first dash-number pattern
      [FILTER]
          Name                parser
          Match               kube.*
          Key_Name            pod_name
          Parser              service_name_extractor
          Preserve_Key        On

      # Rewrite tags based on known service names for routing to service-specific indices
      [FILTER]
          Name                rewrite_tag
          Match               kube.*
          Rule                service_name attendance-service service.attendance-service true
          Rule                service_name audit-service service.audit-service true
          Rule                service_name compliance-service service.compliance-service true
          Rule                service_name employee-service service.employee-service true
          Rule                service_name leave-service service.leave-service true
          Rule                service_name notification-service service.notification-service true
          Rule                service_name user-service service.user-service true

      [FILTER]
          Name                nest
          Match               kube.*
          Operation           nest
          Wildcard            k8s_*
          Nest_under          kubernetes
          Remove_prefix       k8s_

    outputs: |
      # Service-specific output
      [OUTPUT]
          Name                opensearch
          Match               service.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-service
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

      # Fallback output for non-service logs (system components)
      [OUTPUT]
          Name                opensearch
          Match               kube.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-system
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

  parsers: |
    [PARSER]
        Name                service_name_extractor
        Format              regex
        Regex               ^(?P<service_name>[a-z0-9]+-[a-z0-9]+)(?:-[a-z0-9]+){1,2}$

  env:
    - name: OPENSEARCH_PORT
      value: "9200"
    - name: OPENSEARCH_HOST
      valueFrom:
        secretKeyRef:
          name: opensearch-credentials
          key: host
    - name: CLUSTER_NAME
      value: "hrms-cluster"

  envWithTpl:
    - name: ENVIRONMENT
      value: "{{ .Values.environment }}"
