fluent-bit:
  backend:
    type: opensearch

  flush: 1
  logLevel: info

  serviceAccount:
    create: true

  rbac:
    create: true

  # Container volume mounts for accessing host logs
  volumeMounts:
    - name: varlog
      mountPath: /var/log
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: etcmachineid
      mountPath: /etc/machine-id
      readOnly: true

  # DaemonSet volumes backing the container mounts
  daemonSetVolumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: etcmachineid
      hostPath:
        path: /etc/machine-id
        type: FileOrCreate

  config:
    inputs: |
      [INPUT]
          Name              tail
          Path              /var/log/containers/*.log
          Parser            docker
          Tag               kube.*
          DB                /var/log/flb_kube.db
          Mem_Buf_Limit     50MB
          Refresh_Interval  5
          Skip_Long_Lines   On

    filters: |
      [FILTER]
          Name                kubernetes
          Match               kube.*
          Kube_URL            https://kubernetes.default.svc:443
          Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix     kube.var.log.containers.
          Merge_Log           On
          Keep_Log            Off
          K8S-Logging.Parser  On
          K8S-Logging.Exclude On
          Labels              On
          Annotations         Off

      # Lift kubernetes nested object to top level with k8s_ prefix
      [FILTER]
          Name                nest
          Match               kube.*
          Operation           lift
          Nested_under        kubernetes
          Add_prefix          k8s_

      # Add environment and cluster info
      [FILTER]
          Name                modify
          Match               kube.*
          Add                 environment ${ENVIRONMENT}
          Add                 cluster ${CLUSTER_NAME}

      # Extract service name from labels and add common fields
      [FILTER]
          Name                modify
          Match               kube.*
          Copy                k8s_labels_app service_name
          Copy                k8s_labels_tier tier
          Copy                k8s_container_name container_name
          Copy                k8s_pod_name pod_name
          Copy                k8s_namespace_name namespace
          Add                 log_level INFO

      # Update log_level for ERROR logs
      [FILTER]
          Name                grep
          Match               kube.*
          Regex               log (ERROR|error|Error)

      [FILTER]
          Name                modify
          Match               kube.*
          Add                 log_level ERROR

      # Route by container_name for service separation
      [FILTER]
          Name                rewrite_tag
          Match               kube.*
          Rule                k8s_container_name attendance-service service.attendance-service true
          Rule                k8s_container_name audit-service service.audit-service true
          Rule                k8s_container_name compliance-service service.compliance-service true
          Rule                k8s_container_name employee-service service.employee-service true
          Rule                k8s_container_name leave-service service.leave-service true
          Rule                k8s_container_name notification-service service.notification-service true
          Rule                k8s_container_name user-service service.user-service true

      # Nest all k8s fields under kubernetes object for clean structure
      [FILTER]
          Name                nest
          Match               kube.*
          Operation           nest
          Wildcard            k8s_*
          Nest_under          kubernetes
          Remove_prefix       k8s_

    outputs: |
      # Service-specific output
      [OUTPUT]
          Name                opensearch
          Match               service.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-service
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

      # Fallback output for non-service logs (system components)
      [OUTPUT]
          Name                opensearch
          Match               kube.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-system
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

  env:
    - name: OPENSEARCH_PORT
      value: "9200"
    - name: OPENSEARCH_HOST
      valueFrom:
        secretKeyRef:
          name: opensearch-credentials
          key: host
    - name: CLUSTER_NAME
      value: "hrms-cluster"

  envWithTpl:
    - name: ENVIRONMENT
      value: "{{ .Values.environment }}"
