fluent-bit:
  backend:
    type: opensearch

  # Let the upstream fluent-bit subchart render the [SERVICE] block
  # (it expects a string at .Values.config.service). Provide the
  # numeric/string values the chart uses instead of supplying a
  # table for `.config.service` which causes the coalesce/type error.
  flush: 1
  logLevel: info

  serviceAccount:
    create: true

  rbac:
    create: true

  # Mount the Lua script from ConfigMap
  volumeMounts:
    - name: lua-scripts
      mountPath: /fluent-bit/scripts

  daemonSetVolumes:
    - name: lua-scripts
      configMap:
        name: fluentbit-lua-scripts

  config:
    inputs: |
      [INPUT]
          Name              tail
          Path              /var/log/containers/*.log
          Parser            docker
          Tag               kube.*
          DB                /var/log/flb_kube.db
          Mem_Buf_Limit     50MB
          Refresh_Interval  5
          Skip_Long_Lines   On

    filters: |
      [FILTER]
          Name                kubernetes
          Match               kube.*
          Kube_URL            https://kubernetes.default.svc:443
          Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix     kube.var.log.containers.
          Merge_Log           On
          Keep_Log            Off
          K8S-Logging.Parser  On
          K8S-Logging.Exclude On
          Labels              On
          Annotations         Off

      [FILTER]
          Name                nest
          Match               kube.*
          Operation           lift
          Nested_under        kubernetes
          Add_prefix          k8s_

      [FILTER]
          Name                modify
          Match               kube.*
          Add                 environment ${ENVIRONMENT}
          Add                 cluster ${CLUSTER_NAME}
          Copy                k8s_pod_name pod_name
          Copy                k8s_namespace_name namespace
          Copy                k8s_container_name container_name
          Copy                k8s_labels service

      # Extract service name from pod name and labels
      # This Lua script enriches logs with service_name field
      [FILTER]
          Name                lua
          Match               kube.*
          Script              /fluent-bit/scripts/extract_service.lua
          Call                extract_service_from_pod

      # Rewrite tags based on service name for routing to service-specific indices
      # Format: Match rule "{field} {regex}" "{output_tag}" {keep}
      [FILTER]
          Name                rewrite_tag
          Match               kube.*
          Rule                "service_name ^(attendance-service|audit-service|compliance-service|employee-service|leave-service|notification-service|user-service)$" "service.$1" false

      [FILTER]
          Name                nest
          Match               kube.*
          Operation           nest
          Wildcard            k8s_*
          Nest_under          kubernetes
          Remove_prefix       k8s_

    outputs: |
      # Service-specific output - routes logs to service-prefixed indices
      # Uses service_name field extracted by Lua script to build index name
      [OUTPUT]
          Name                opensearch
          Match               service.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-${FLUENTBIT_TAG_PART1}
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

      # Fallback output for non-service logs (system components)
      [OUTPUT]
          Name                opensearch
          Match               kube.*
          Host                ${OPENSEARCH_HOST}
          Port                ${OPENSEARCH_PORT}
          Type                _doc
          Suppress_Type_Name  On
          tls                 Off
          Logstash_Format     On
          Logstash_Prefix     logs-${ENVIRONMENT}-system
          Logstash_DateFormat %Y.%m.%d
          Time_Key            @timestamp
          Generate_ID         On
          Replace_Dots        On
          Trace_Error         On

    # Add later
    # HTTP_User           ${OPENSEARCH_USER}
    # HTTP_Passwd         ${OPENSEARCH_PASSWORD}
    # tls.verify          Off



  env:
    - name: OPENSEARCH_PORT
      value: "9200"
    - name: OPENSEARCH_HOST
      valueFrom:
        secretKeyRef:
          name: opensearch-credentials
          key: host
    - name: CLUSTER_NAME
      value: "hrms-cluster"
    # - name: OPENSEARCH_USER
    #   valueFrom:
    #     secretKeyRef:
    #       name: opensearch-credentials
    #       key: username
    # - name: OPENSEARCH_PASSWORD
    #   valueFrom:
    #     secretKeyRef:
    #       name: opensearch-credentials
    #       key: password

  envWithTpl:
    - name: ENVIRONMENT
      value: "{{ .Values.environment }}"
