apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: logging

# Create ConfigMap from Lua script
configMapGenerator:
  - name: fluentbit-lua-scripts
    files:
      - scripts/extract_service.lua
    options:
      disableNameSuffixHash: true

# Helm chart dependency
helmCharts:
  - name: fluentbit
    repo: https://fluent.github.io/helm-charts
    version: 0.53.0
    releaseName: fluent-bit
    namespace: logging
    valuesFiles:
      - values-shared.yaml
    valuesInline:
      fluent-bit:
        # Volume mounts MUST be defined in valuesInline because the upstream
        # Helm chart does not expose volumeMounts and daemonSetVolumes as
        # configurable options. This is the only way to mount host paths and
        # the lua-scripts ConfigMap.
        volumeMounts:
          - name: varlog
            mountPath: /var/log
          - name: varlibdockercontainers
            mountPath: /var/lib/docker/containers
            readOnly: true
          - name: etcmachineid
            mountPath: /etc/machine-id
            readOnly: true
          - name: lua-scripts
            mountPath: /fluent-bit/scripts
        daemonSetVolumes:
          - name: varlog
            hostPath:
              path: /var/log
          - name: varlibdockercontainers
            hostPath:
              path: /var/lib/docker/containers
          - name: etcmachineid
            hostPath:
              path: /etc/machine-id
              type: FileOrCreate
          - name: lua-scripts
            configMap:
              name: fluentbit-lua-scripts
