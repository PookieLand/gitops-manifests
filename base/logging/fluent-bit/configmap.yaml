apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        1
        Daemon       Off
        Log_Level    info
        Parsers_File parsers.conf

    [INPUT]
        Name        tail
        Tag         kube.*
        Path        /var/log/containers/*.log
        Parser      docker
        DB          /var/log/flb_kube.db
        Mem_Buf_Limit 5MB
        Refresh_Interval 10

    [FILTER]
        Name        kubernetes
        Match       kube.*
        Merge_Log   On
        K8S-Logging.Parser On
        K8S-Logging.Exclude Off

    # Derive `environment` dynamically from the Kubernetes namespace using Lua.
    [FILTER]
      Name        lua
      Match       kube.*
      script      /fluent-bit/scripts/set_env.lua
      call        set_env

    [FILTER]
      Name        modify
      Match       *
      Add         environment ${ENVIRONMENT}

    [OUTPUT]
      Name        stdout
      Match       *

  parsers.conf: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L

  # OpenSearch/Elasticsearch output (enabled here). Ensure OPENSEARCH_* env
  # vars and ExternalSecret are configured in the DaemonSet.
  # To enable, update the DaemonSet to provide OPENSEARCH_HOST/PORT and a
  # Secret named `fluent-bit-opensearch-secret` with keys `OPENSEARCH_USER`
  # and `OPENSEARCH_PASS` (see secret.yaml template).
  opensearch-output.conf: |
    [OUTPUT]
        Name        es
        Match       *
        Host        ${OPENSEARCH_HOST}
        Port        ${OPENSEARCH_PORT}
        # Use the derived `environment` field in the index name so staging and
        # production logs go to separate indices.
        Index       kubernetes_logs_${environment}
        Type        _doc
        HTTP_User   ${OPENSEARCH_USER}
        HTTP_Passwd ${OPENSEARCH_PASS}
        tls         On
        tls.verify  On

  # Lua script to set environment based on namespace. Maps common namespace
  # names to environment tags and falls back to 'unknown'. Mounted at
  # /fluent-bit/scripts/set_env.lua by the DaemonSet.
  scripts/set_env.lua: |
    function set_env(tag, timestamp, record)
      local ns = nil
      if record["kubernetes"] then
        ns = record["kubernetes"]["namespace_name"]
      end
      local env = "unknown"
      if ns ~= nil then
        local nsl = string.lower(ns)
        if nsl == "production" or nsl:find("prod") then
          env = "production"
        elseif nsl == "staging" or nsl:find("staging") then
          env = "staging"
        end
      end
      record["environment"] = env
      return 1, timestamp, record
    end

