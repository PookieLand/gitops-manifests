apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topics-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: kafka-topics-init
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: OnFailure
      containers:
        - name: kafka-topics-init
          image: confluentinc/cp-kafka:7.6.0
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Waiting for Kafka to be ready..."
              sleep 10

              echo "Creating Kafka topics for HRMS..."

              # =========================
              # User lifecycle events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-created --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-updated --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-deleted --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-suspended --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-activated --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-role-changed --partitions 3 --replication-factor 1

              # =========================
              # Onboarding events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-onboarding-initiated --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-onboarding-asgardeo-created --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-onboarding-employee-created --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-onboarding-completed --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user-onboarding-failed --partitions 3 --replication-factor 1

              # =========================
              # Special events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic employee-special-birthday --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic employee-special-work-anniversary --partitions 3 --replication-factor 1

              # =========================
              # HR events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-probation-ending --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-probation-ended --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-contract-expiring --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-contract-expired --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-performance-review-due --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-salary-increment-due --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-leave-balance-low --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic hr-excessive-leave --partitions 3 --replication-factor 1

              # =========================
              # Notification events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-welcome-email --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-invitation-email --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-password-set --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-sent --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-failed --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-delivered --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-late-arrival --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-absent-employee --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-overtime-alert --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-leave-pending --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-leave-approved --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-leave-rejected --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-leave-reminder --partitions 3 --replication-factor 1

              # =========================
              # Audit events
              # =========================
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-user-action --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-employee-action --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-attendance-action --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-leave-action --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-notification-action --partitions 3 --replication-factor 1
              kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic audit-compliance-action --partitions 3 --replication-factor 1

              echo "Listing all created topics:"
              kafka-topics --bootstrap-server kafka:9092 --list

              echo "Kafka topics created successfully!"
